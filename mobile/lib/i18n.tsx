import { createContext, useContext, useEffect, useMemo, useState } from "react";
import { I18nManager } from "react-native";
import AsyncStorage from "@react-native-async-storage/async-storage";

type Lang = "en" | "ar";

const I18N_STORAGE_KEY = "app-language";

const baseStrings = {
  store: "Store",
  cart: "Cart",
  orders: "Orders",
  profile: "Profile",
  checkout: "Checkout",
  membership: "Membership",
  wallet: "Wallet",
  settings: "Settings",
  addToCart: "Add to cart",
  placeOrder: "Place order",
  placingOrder: "Checking out",
  login: "Login",
  register: "Create account",
  forgotPassword: "Reset password",
  email: "Email",
  password: "Password",
  name: "Full name",
  continue: "Continue",
  backToLogin: "Back to login",
  pushNotifications: "Push notifications",
  language: "Language",
  theme: "Theme",
  system: "System",
  light: "Light",
  dark: "Dark",
  usePoints: "Use points reward",
  yes: "Yes",
  no: "No",
  distance: "Distance",
  deliveryFee: "Delivery fee",
  total: "Total",
  storeLocation: "Store location",
  orderHistory: "Order history",
  helloShopper: "Hello shopper",
  hello: "Hello",
  deliveryTo: "Delivery to",
  loginToLoadLocation: "No selected address.",
  featuredCategories: "Featured categories",
  freshPicks: "Fresh picks",
  amount: "Amount",
  submit: "Submit request",
  submitting: "Submitting...",
  rewards: "Points",
  redeemAvailable: "Reward available",
  balance: "Balance",
  standard: "Standard",
  searchProducts: "Search products",
  shopTagline: "Discover fresh picks in your language & theme",
  shopByCategory: "Shop by category",
  noDescription: "No description",
  products: "Products",
  emptyProducts: "No products found",
  searching: "Searching...",
  subtotal: "Subtotal",
  clearCart: "Clear cart",
  order: "Order",
  status: "Status",
  timeline: "Timeline",
  items: "Items",
  pointsLeft: "points left to unlock a reward",
  earnPoints: "How to earn",
  earnPointsCopy: "Earn points on subtotal after delivery.",
  pointsBalance: "Points balance",
  pointEarnRate: "1 point per {amount} SYP on subtotal.",
  viewPoints: "View points",
  usePointsTitle: "How to use",
  usePointsCopy: "Apply reward during checkout for one order.",
  topUp: "Add funds to your wallet",
  topUpRequest: "Top-up request",
  registerFailed: "Could not register",
  invalidCredentials: "Invalid credentials",
  loginHeadline: "Grocery on the go.",
  loginSubhead: "Earn points, track orders, and level up your membership.",
  sendLink: "Send link",
  resetCopy: "We will send a recovery link to your email.",
  resetSent: "If this email exists, a link was sent.",
  guest: "Guest",
  role: "Role",
  logout: "Logout",
  address: "Address",
  phone: "Phone",
  latitude: "Latitude",
  longitude: "Longitude",
  level: "Level",
  remainingToNext: "Remaining to ",
  graceDays: "Grace days",
  gracePeriod: "Grace period",
  gracePeriodActive: "Grace period active",
  graceKeepLevel: "Keep your balance above",
  graceUntil: "Grace until",
  benefits: "Benefits",
  priorityDelivery: "Priority delivery",
  loyalOffers: "Extra offers for loyal members",
  congrats: "Congratulations! You are at the top level membership",
  leveledUp: "You just leveled up.",
  loginToSeeOrders: "Please login to view your orders.",
  walletLedger: "History",
  noTransactions: "No transactions yet",
  filters: "Filters",
  clear: "Clear",
  sortBy: "Sort by",
  relevance: "Relevance",
  priceLowHigh: "Price: Low to High",
  priceHighLow: "Price: High to Low",
  price: "Price",
  all: "All",
  under50k: "Under 50K",
  under100k: "Under 100K",
  over100k: "100K +",
  apply: "Apply",
  remove: "Remove",
  loginToSeeProfile: "Please login to view your profile.",
  confirmRemove: "Remove item?",
  confirmRemoveCopy: "Are you sure you want to remove this item from your cart?",
  dontAskAgain: "Don't ask again",
  emptyCartTitle: "Your cart is empty",
  emptyCartCopy: "Add items to your cart to see them here.",
  startBrowsing: "Start browsing",
  confirmClearCart: "Clear cart?",
  confirmClearCartCopy: "This will remove all items from your cart.",
  back: "Back",
  viewAll: "View all",
  tapToSetLocation: "Enter coordinates to set location",
  loginToCheckout: "Login to checkout",
  savedAddresses: "Saved addresses",
  addAddress: "Add address",
  editAddress: "Edit address",
  noOrders: "No orders yet",
  noOrdersHint: "Start browsing to place your first order.",
  notLoggedIn: "You are not logged in",
  guestInfo: "Guest information",
  fillGuestForm: "Fill the form below or login.",
  loginOrGuest: "Login or checkout as guest",
  chooseAddress: "Choose address",
  noAddresses: "No addresses saved yet.",
  label: "Label",
  save: "Save",
  cancel: "Cancel",
  delete: "Delete",
  edit: "Edit",
  useCurrentLocation: "Use current location",
  show: "Show",
  hide: "Hide",
  manageAddresses: "Manage addresses",
  change: "Change",
  paymentMethod: "Payment method",
  close: "Close",
  locationDenied: "Permission denied",
  locationError: "Could not get location",
  noResults: "No results found",
  learnMore: "Learn more",
  WalletBalance: "Wallet balance",
  syp: "SYP",
  km:"Km",
  alreadyHaveAnAccount:"Already have an account?"
};

const arStrings: Record<string, string> = {
  store: "المتجر",
  cart: "السلة",
  orders: "الطلبات",
  profile: "الملف الشخصي",
  checkout: "إتمام الطلب",
  membership: "العضوية",
  wallet: "المحفظة",
  settings: "الإعدادات",
  addToCart: "أضف إلى السلة",
  placeOrder: "تأكيد الطلب",
  placingOrder: "جارٍ إتمام الطلب",
  login: "تسجيل الدخول",
  register: "إنشاء حساب",
  forgotPassword: "استعادة كلمة المرور",
  email: "البريد الإلكتروني",
  password: "كلمة المرور",
  name: "الاسم الكامل",
  continue: "متابعة",
  backToLogin: "العودة لتسجيل الدخول",
  pushNotifications: "إشعارات الدفع",
  language: "اللغة",
  theme: "المظهر",
  system: "النظام",
  light: "فاتح",
  dark: "داكن",
  usePoints: "استخدم نقاط المكافأة",
  yes: "نعم",
  no: "لا",
  distance: "المسافة",
  deliveryFee: "رسوم التوصيل",
  total: "الإجمالي",
  storeLocation: "موقع المتجر",
  orderHistory: "سجل الطلبات",
  helloShopper: "أهلاً بالمتسوق",
  hello: "مرحباً",
  deliveryTo: "التوصيل إلى",
  loginToLoadLocation: "سجّل الدخول لعرض عنوانك.",
  featuredCategories: "فئات مميزة",
  freshPicks: "مختارات طازجة",
  amount: "المبلغ",
  submit: "إرسال الطلب",
  submitting: "جارٍ الإرسال",
  rewards: "النقاط",
  redeemAvailable: "مكافأة متاحة",
  balance: "الرصيد",
  standard: "أساسي",
  searchProducts: "ابحث عن المنتجات",
  shopTagline: "اكتشف المنتجات بلغتك وبمظهرك",
  shopByCategory: "تسوق حسب الفئة",
  noDescription: "بدون وصف",
  products: "المنتجات",
  emptyProducts: "لا توجد منتجات",
  searching: "جارٍ البحث...",
  subtotal: "المجموع الفرعي",
  clearCart: "إفراغ السلة",
  order: "الطلب",
  status: "الحالة",
  timeline: "المخطط الزمني",
  items: "العناصر",
  pointsLeft: "نقاط متبقية لفتح المكافأة",
  earnPoints: "كيفية كسب النقاط",
  earnPointsCopy: "اكسب نقاطاً على المبلغ الفرعي بعد التوصيل.",
  pointsBalance: "رصيد النقاط",
  pointEarnRate: "نقطة واحدة لكل {amount} ل.س على المجموع الفرعي.",
  viewPoints: "عرض النقاط",
  usePointsTitle: "كيفية الاستخدام",
  usePointsCopy: "طبق المكافأة أثناء الدفع لطلب واحد.",
  topUp: "شحن الرصيد",
  topUpRequest: "طلب شحن",
  registerFailed: "تعذر إنشاء الحساب",
  invalidCredentials: "بيانات غير صحيحة",
  loginHeadline: "بقالتك في متناولك.",
  loginSubhead: "اكسب النقاط، تتبع الطلبات، وارتقِ بعضويتك.",
  sendLink: "إرسال الرابط",
  resetCopy: "سنرسل رابط الاستعادة إلى بريدك.",
  resetSent: "إذا كان البريد موجوداً، تم إرسال رابط.",
  guest: "زائر",
  role: "الدور",
  logout: "تسجيل الخروج",
  address: "العنوان",
  phone: "الهاتف",
  latitude: "خط العرض",
  longitude: "خط الطول",
  level: "المستوى",
  remainingToNext: "متبقي إلى ",
  graceDays: "أيام السماح",
  gracePeriod: "فترة السماح",
  gracePeriodActive: "فترة السماح مفعّلة",
  graceKeepLevel: "حافظ على الرصيد فوق",
  graceUntil: "فترة السماح حتى",
  benefits: "المزايا",
  priorityDelivery: "توصيل أولوية",
  loyalOffers: "عروض إضافية للوفاء",
  congrats: "تهانينا! أنت في أعلى مستوى عضوية",
  leveledUp: "لقد ارتقيت للتو.",
  loginToSeeOrders: "يرجى تسجيل الدخول لعرض طلباتك.",
  walletLedger: "السجل",
  noTransactions: "لا توجد حركات بعد",
  filters: "الفلاتر",
  clear: "تصفية",
  sortBy: "الترتيب حسب",
  relevance: "الصلة",
  priceLowHigh: "السعر: من الأقل للأعلى",
  priceHighLow: "السعر: من الأعلى للأقل",
  price: "السعر",
  all: "الكل",
  under50k: "أقل من 50 ألف",
  under100k: "أقل من 100 ألف",
  over100k: "100 ألف وأكثر",
  apply: "تطبيق",
  remove: "إزالة",
  loginToSeeProfile: "يرجى تسجيل الدخول لعرض ملفك.",
  confirmRemove: "إزالة العنصر؟",
  confirmRemoveCopy: "هل أنت متأكد أنك تريد إزالة هذا العنصر من سلتك؟",
  dontAskAgain: "لا تسأل مرة أخرى",
  emptyCartTitle: "سلتك فارغة",
  emptyCartCopy: "أضف عناصر إلى سلتك لتظهر هنا.",
  startBrowsing: "ابدأ التسوق",
  confirmClearCart: "إفراغ السلة؟",
  confirmClearCartCopy: "سيؤدي هذا إلى إزالة كل العناصر من السلة.",
  back: "رجوع",
  viewAll: "عرض الكل",
  tapToSetLocation: "أدخل الإحداثيات لتعيين الموقع",
  loginToCheckout: "تسجيل الدخول لإتمام الطلب",
  savedAddresses: "العناوين المحفوظة",
  addAddress: "إضافة عنوان",
  editAddress: "تعديل العنوان",
  noOrders: "لا توجد طلبات بعد",
  noOrdersHint: "ابدأ التسوق لتضع أول طلب.",
  notLoggedIn: "لست مسجلاً",
  guestInfo: "معلومات الزائر",
  fillGuestForm: "املأ النموذج أدناه أو سجّل الدخول.",
  loginOrGuest: "تسجيل الدخول أو الدفع كزائر",
  chooseAddress: "اختر عنواناً",
  noAddresses: "لا توجد عناوين محفوظة بعد.",
  label: "المسمى",
  save: "حفظ",
  cancel: "إلغاء",
  delete: "حذف",
  edit: "تعديل",
  useCurrentLocation: "استخدام موقعي الحالي",
  show: "إظهار",
  hide: "إخفاء",
  manageAddresses: "إدارة العناوين",
  change: "تغيير",
  paymentMethod: "طريقة الدفع",
  close: "إغلاق",
  locationDenied: "تم رفض إذن الموقع",
  locationError: "تعذر الحصول على الموقع",
  noResults: "لا توجد نتائج",
  learnMore: "اعرف المزيد",
  WalletBalance: "رصيد المحفظة",
  syp: "ل.س",
  km: "كم",  
  alreadyHaveAnAccount:"هل أنشأت حساب من قبل؟"
};

const messages: Record<Lang, Record<string, string>> = {
  en: { ...baseStrings },
  ar: { ...arStrings },
};

interface I18nContextValue {
  lang: Lang;
  t: (key: string) => string;
  setLang: (lang: Lang) => void;
  isRTL: boolean;
}

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

const detectDeviceLang = (): Lang => {
  const locale = (Intl.DateTimeFormat().resolvedOptions().locale || "en").toLowerCase();
  return locale.startsWith("ar") ? "ar" : "en";
};

export const I18nProvider = ({ children }: { children: React.ReactNode }) => {
  const [lang, setLangState] = useState<Lang>(detectDeviceLang());

  useEffect(() => {
    AsyncStorage.getItem(I18N_STORAGE_KEY).then((stored) => {
      if (stored === "en" || stored === "ar") setLangState(stored);
    });
  }, []);

  useEffect(() => {
    const shouldRTL = lang === "ar";
    if (I18nManager.isRTL !== shouldRTL) {
      I18nManager.allowRTL(true);
      I18nManager.forceRTL(shouldRTL);
      I18nManager.swapLeftAndRightInRTL(true);
      // Note: Expo/React Native may require an app reload for full mirroring; components use isRTL for live layout.
    }
  }, [lang]);

  const setLang = (next: Lang) => {
    setLangState(next);
    AsyncStorage.setItem(I18N_STORAGE_KEY, next).catch(() => { });
  };

  const value = useMemo<I18nContextValue>(() => {
    const dict = messages[lang] || messages.en;
    const t = (key: string) => dict[key] ?? messages.en[key] ?? key;
    return { lang, t, setLang, isRTL: lang === "ar" };
  }, [lang]);

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
};

export const useI18n = () => {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error("useI18n must be used within I18nProvider");
  return ctx;
};
